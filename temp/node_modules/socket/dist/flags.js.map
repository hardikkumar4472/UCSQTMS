{"version":3,"file":"flags.js","sources":["../src/flags.mts"],"sourcesContent":["import os from 'node:os'\n\nimport meow from 'meow'\nimport terminalLink from 'terminal-link'\n\nimport constants from './constants.mts'\n\nimport type { Flag } from 'meow'\n\n// Meow doesn't expose this.\nexport type AnyFlag = StringFlag | BooleanFlag | NumberFlag\n\nexport type BooleanFlag =\n  | Flag<'boolean', boolean>\n  | Flag<'boolean', boolean[], true>\n\nexport type NumberFlag = Flag<'number', number> | Flag<'number', number[], true>\n\nexport type StringFlag = Flag<'string', string> | Flag<'string', string[], true>\n\nexport type MeowFlag = AnyFlag & { description: string; hidden?: boolean }\n\n// We use this description in getFlagListOutput, meow doesn't care.\nexport type MeowFlags = Record<string, MeowFlag>\n\ntype RawSpaceSizeFlags = {\n  maxOldSpaceSize: number\n  maxSemiSpaceSize: number\n}\n\nlet _rawSpaceSizeFlags: RawSpaceSizeFlags | undefined\nfunction getRawSpaceSizeFlags(): RawSpaceSizeFlags {\n  if (_rawSpaceSizeFlags === undefined) {\n    const cli = meow({\n      argv: process.argv.slice(2),\n      // Prevent meow from potentially exiting early.\n      autoHelp: false,\n      autoVersion: false,\n      flags: {\n        maxOldSpaceSize: {\n          type: 'number',\n          default: 0,\n        },\n        maxSemiSpaceSize: {\n          type: 'number',\n          default: 0,\n        },\n      },\n      importMeta: { url: import.meta.url } as ImportMeta,\n    })\n    _rawSpaceSizeFlags = {\n      maxOldSpaceSize: cli.flags['maxOldSpaceSize'],\n      maxSemiSpaceSize: cli.flags['maxSemiSpaceSize'],\n    }\n  }\n  return _rawSpaceSizeFlags\n}\n\nlet _maxOldSpaceSizeFlag: number | undefined\nexport function getMaxOldSpaceSizeFlag(): number {\n  if (_maxOldSpaceSizeFlag === undefined) {\n    _maxOldSpaceSizeFlag = getRawSpaceSizeFlags().maxOldSpaceSize\n    if (!_maxOldSpaceSizeFlag) {\n      const match = /(?<=--max-old-space-size=)\\d+/.exec(\n        constants.ENV.NODE_OPTIONS,\n      )?.[0]\n      _maxOldSpaceSizeFlag = match ? Number(match) : 0\n    }\n    if (!_maxOldSpaceSizeFlag) {\n      // Default value determined by available system memory.\n      _maxOldSpaceSizeFlag = Math.floor(\n        // Total system memory in MiB.\n        (os.totalmem() / 1024 / 1024) *\n          // Set 75% of total memory (safe buffer to avoid system pressure).\n          0.75,\n      )\n    }\n  }\n  return _maxOldSpaceSizeFlag\n}\n// Ensure export because dist/flags.js is required in src/constants.mts.\n// eslint-disable-next-line n/exports-style\nif (typeof exports === 'object' && exports !== null) {\n  // eslint-disable-next-line n/exports-style\n  exports.getMaxOldSpaceSizeFlag = getMaxOldSpaceSizeFlag\n}\n\nlet _maxSemiSpaceSizeFlag: number | undefined\nexport function getMaxSemiSpaceSizeFlag(): number {\n  if (_maxSemiSpaceSizeFlag === undefined) {\n    _maxSemiSpaceSizeFlag = getRawSpaceSizeFlags().maxSemiSpaceSize\n    if (!_maxSemiSpaceSizeFlag) {\n      const match = /(?<=--max-semi-space-size=)\\d+/.exec(\n        constants.ENV.NODE_OPTIONS,\n      )?.[0]\n      _maxSemiSpaceSizeFlag = match ? Number(match) : 0\n    }\n    if (!_maxSemiSpaceSizeFlag) {\n      const maxOldSpaceSize = getMaxOldSpaceSizeFlag()\n      // Dynamically scale semi-space size based on max-old-space-size.\n      // https://nodejs.org/api/cli.html#--max-semi-space-sizesize-in-mib\n      if (maxOldSpaceSize <= 8192) {\n        // Use tiered values for smaller heaps to avoid excessive young\n        // generation size. This helps stay within safe memory limits on\n        // constrained systems or CI.\n        if (maxOldSpaceSize <= 512) {\n          _maxSemiSpaceSizeFlag = 4\n        } else if (maxOldSpaceSize <= 1024) {\n          _maxSemiSpaceSizeFlag = 8\n        } else if (maxOldSpaceSize <= 2048) {\n          _maxSemiSpaceSizeFlag = 16\n        } else if (maxOldSpaceSize <= 4096) {\n          _maxSemiSpaceSizeFlag = 32\n        } else {\n          _maxSemiSpaceSizeFlag = 64\n        }\n      } else {\n        // For large heaps (> 8 GiB), compute semi-space size using a log-scaled\n        // function.\n        //\n        // The idea:\n        //   - log2(16384 MiB) = 14  → semi = 14 * 8 = 112\n        //   - log2(32768 MiB) = 15  → semi = 15 * 8 = 120\n        //   - Scales gradually as heap increases, avoiding overly large jumps\n        //\n        // Each 1 MiB of semi-space adds ~3 MiB to the total young generation\n        // (V8 uses 3 spaces). So this keeps semi-space proportional, without\n        // over committing.\n        //\n        // Also note: V8 won’t benefit much from >256 MiB semi-space unless\n        // you’re allocating large short-lived objects very frequently\n        // (e.g. large arrays, buffers).\n        const log2OldSpace = Math.log2(maxOldSpaceSize)\n        const scaledSemiSpace = Math.floor(log2OldSpace) * 8\n        _maxSemiSpaceSizeFlag = scaledSemiSpace\n      }\n    }\n  }\n  return _maxSemiSpaceSizeFlag\n}\n// Ensure export because dist/flags.js is required in src/constants.mts.\n// eslint-disable-next-line n/exports-style\nif (typeof exports === 'object' && exports !== null) {\n  // eslint-disable-next-line n/exports-style\n  exports.getMaxSemiSpaceSizeFlag = getMaxSemiSpaceSizeFlag\n}\n\nexport const commonFlags: MeowFlags = {\n  config: {\n    type: 'string',\n    default: '',\n    description: 'Override the local config with this JSON',\n    hidden: true,\n  },\n  dryRun: {\n    type: 'boolean',\n    default: false,\n    description:\n      'Do input validation for a command and exit 0 when input is ok',\n    // Only show in root command.\n    hidden: true,\n  },\n  help: {\n    type: 'boolean',\n    default: false,\n    shortFlag: 'h',\n    description: 'Print this help',\n    hidden: true,\n  },\n  maxOldSpaceSize: {\n    type: 'number',\n    get default() {\n      return getMaxOldSpaceSizeFlag()\n    },\n    description: `Set Node's V8 ${terminalLink('--max-old-space-size', 'https://nodejs.org/api/cli.html#--max-old-space-sizesize-in-mib')} option`,\n    hidden: true,\n  },\n  maxSemiSpaceSize: {\n    type: 'number',\n    get default() {\n      return getMaxSemiSpaceSizeFlag()\n    },\n    description: `Set Node's V8 ${terminalLink('--max-semi-space-size', 'https://nodejs.org/api/cli.html#--max-semi-space-sizesize-in-mib')} option`,\n    hidden: true,\n  },\n\n  // I know this would be `--no-banner` but that doesn't work with cdxgen.\n  // Mostly for internal usage anyways.\n  nobanner: {\n    type: 'boolean',\n    default: false,\n    description: 'Hide the Socket banner',\n    hidden: true,\n  },\n  // Hidden to allow custom documenting of the negated `--no-spinner` variant.\n  spinner: {\n    type: 'boolean',\n    default: true,\n    description: 'Hide the console spinner',\n    hidden: true,\n  },\n}\n\nexport const outputFlags: MeowFlags = {\n  json: {\n    type: 'boolean',\n    default: false,\n    description: 'Output result as json',\n    shortFlag: 'j',\n  },\n  markdown: {\n    type: 'boolean',\n    default: false,\n    description: 'Output result as markdown',\n    shortFlag: 'm',\n  },\n}\n\nexport const validationFlags: MeowFlags = {\n  all: {\n    type: 'boolean',\n    default: false,\n    description: 'Include all issues',\n  },\n  strict: {\n    type: 'boolean',\n    default: false,\n    description: 'Exits with an error code if any matching issues are found',\n  },\n}\n"],"names":["autoHelp","autoVersion","flags","maxOldSpaceSize","type","default","maxSemiSpaceSize","importMeta","url","_rawSpaceSizeFlags","_maxOldSpaceSizeFlag","os","_maxSemiSpaceSizeFlag","config","description","hidden","dryRun","help","shortFlag","nobanner","spinner","json","markdown"],"mappings":";;;;;;;AASA;;AAaA;;AAQA;AACA;;;;AAIM;AACAA;AACAC;AACAC;AACEC;AACEC;AACAC;;AAEFC;AACEF;AACAC;AACF;;AAEFE;AAAcC;AAAqB;AACrC;AACAC;AACEN;AACAG;;AAEJ;AACA;AACF;AAEA;AACO;;AAEHI;;AAEE;;AAIF;;AAEE;;AAEE;AACCC;AACC;AACA;AAEN;AACF;AACA;AACF;AACA;AACA;AACA;AACE;;AAEF;AAEA;AACO;;AAEHC;;AAEE;;AAIF;;AAEE;AACA;AACA;;AAEE;AACA;AACA;;AAEEA;AACF;AACEA;AACF;AACEA;AACF;AACEA;AACF;AACEA;AACF;AACF;AACE;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;AACA;;AAEAA;AACF;AACF;AACF;AACA;AACF;AACA;AACA;AACA;AACE;;AAEF;AAEO;AACLC;AACET;AACAC;AACAS;AACAC;;AAEFC;AACEZ;AACAC;AACAS;AAEA;AACAC;;AAEFE;AACEb;AACAC;AACAa;AACAJ;AACAC;;AAEFZ;AACEC;;;;;AAKAW;;AAEFT;AACEF;;;;;AAKAW;;AAGF;AACA;AACAI;AACEf;AACAC;AACAS;AACAC;;AAEF;AACAK;AACEhB;AACAC;AACAS;AACAC;AACF;AACF;AAEO;AACLM;AACEjB;AACAC;AACAS;AACAI;;AAEFI;AACElB;AACAC;AACAS;AACAI;AACF;AACF;;;","debugId":"b66b8ede-e183-47e8-b952-5c3d3f774449"}